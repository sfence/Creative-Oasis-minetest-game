name: GitHub â†’ Discord Embed Notifications

on:
  push:
  pull_request:
  issues:
  release:
  fork:
  create:
  delete:
  watch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install requests
        run: pip install requests

      - name: Send Discord Embed Notification
        run: |
          python - <<'EOF'
          import os, json, requests

          WEBHOOK = os.environ.get("DISCORD_WEBHOOK")
          if not WEBHOOK:
              raise Exception("DISCORD_WEBHOOK secret is not set")

          event_name = os.environ.get("GITHUB_EVENT_NAME", "unknown")
          repo = os.environ.get("GITHUB_REPOSITORY", "unknown")
          actor = os.environ.get("GITHUB_ACTOR", "unknown")
          action = os.environ.get("GITHUB_EVENT_ACTION", "N/A")
          event_path = os.environ.get("GITHUB_EVENT_PATH")

          embed = {
              "title": f"GitHub Event: {event_name}",
              "color": 0x2ecc71,  # green
              "fields": [
                  {"name": "Repository", "value": repo, "inline": True},
                  {"name": "Actor", "value": actor, "inline": True},
                  {"name": "Action", "value": action, "inline": True}
              ]
          }

          # Read event JSON
          if event_path and os.path.exists(event_path):
              try:
                  data = json.load(open(event_path))
              except Exception:
                  data = {}

              # Push commits
              if event_name == "push":
                  commits = data.get("commits", [])
                  if commits:
                      commit_text = "\n".join(f"- {c.get('message')} ({c.get('author', {}).get('name','')})" for c in commits)
                      embed["fields"].append({"name": "Commits", "value": commit_text})

              # Issue
              if event_name == "issues":
                  issue = data.get("issue", {})
                  title = issue.get("title")
                  url = issue.get("html_url")
                  if title:
                      embed["fields"].append({"name": "Issue", "value": f"[{title}]({url})"})

              # Pull request
              if event_name == "pull_request":
                  pr = data.get("pull_request", {})
                  title = pr.get("title")
                  url = pr.get("html_url")
                  if title:
                      embed["fields"].append({"name": "Pull Request", "value": f"[{title}]({url})"})

              # Release
              if event_name == "release":
                  release = data.get("release", {})
                  name = release.get("name")
                  tag = release.get("tag_name")
                  url = release.get("html_url")
                  if name:
                      embed["fields"].append({"name": "Release", "value": f"[{name} ({tag})]({url})"})

              # Fork
              if event_name == "fork":
                  forkee = data.get("forkee", {}).get("full_name")
                  if forkee:
                      embed["fields"].append({"name": "Forked Repository", "value": forkee})

              # Create
              if event_name == "create":
                  ref_type = data.get("ref_type")
                  ref = data.get("ref")
                  if ref_type and ref:
                      embed["fields"].append({"name": "Created", "value": f"{ref_type}: {ref}"})

              # Delete
              if event_name == "delete":
                  ref_type = data.get("ref_type")
                  ref = data.get("ref")
                  if ref_type and ref:
                      embed["fields"].append({"name": "Deleted", "value": f"{ref_type}: {ref}"})

              # Watch/star
              if event_name == "watch":
                  embed["fields"].append({"name": "Starred", "value": f"{actor} starred the repository"})

          # Send embed to Discord
          payload = {"embeds": [embed]}
          try:
              requests.post(WEBHOOK, json=payload)
          except Exception as e:
              print("Failed to send Discord message:", e)
          EOF
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
